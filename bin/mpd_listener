#!/usr/bin/env ruby
$:.unshift File.join(File.dirname(__FILE__), '../lib')
require 'open-uri'
require 'ruby-mpd'
require 'net/http'
require 'json'
require 'faye_broadcast'
require 'mpd_info'

$stdout.sync = true

FAYE_SERVER_URL = ENV['FAYE_SERVER_URL'] || 'http://localhost:9292/faye'

include FayeBroadcast
include MPDInfo

trap('INT') do
  puts "exiting"
  exit 0
end

# Allow Faye to start up
sleep 5

$mpd = MPD.new '10.0.0.12', 6600

# This might be interesting later on
# $mpd.on :volume do |vol|
#   puts "Volume change: #{vol}"
#   broadcast('/first-sin/mpd', { info: mpd_info, action: "mpd" } )
# end

$mpd.on :song do |song|
  puts "Broadcast >> Song change: #{song.artist} - #{song.title}"
  broadcast('/first-sin/mpd', { info: mpd_info, action: "mpd" } )
end

$mpd.on :state do |state|
  puts "Broadcast >> State change: #{state}"
  broadcast('/first-sin/mpd', { info: mpd_info, action: "mpd" } )
end

$mpd.connect true

while true
  sleep 0.5
end

